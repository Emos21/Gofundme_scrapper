<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FundScraper</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container flex items-center justify-between">
            <a href="/" class="navbar-brand">
                <i class="fas fa-rocket"></i>
                <span>FundScraper</span>
            </a>
            <div class="nav-links">
                <a href="/" class="nav-link"><i class="fas fa-search"></i> Scraper</a>
                <a href="/dashboard" class="nav-link active"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a href="/scheduler" class="nav-link"><i class="fas fa-clock"></i> Scheduler</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="padding: 2rem 1.5rem 4rem;">
        
        <!-- Page Header -->
        <div class="flex items-center justify-between mb-6 animate-fadeInUp">
            <div>
                <h1 class="text-2xl mb-1">Analytics <span class="text-gradient">Dashboard</span></h1>
                <p class="text-secondary">Track campaign performance and funding trends</p>
            </div>
            <div class="flex gap-2">
                <button class="btn btn-secondary btn-sm" onclick="window.location.href='/export/database'">
                    <i class="fas fa-download"></i> Export All
                </button>
                <button class="btn btn-primary btn-sm" onclick="refreshAll()" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-4 gap-4 mb-6 stagger-children">
            <div class="stat-card">
                <div class="stat-icon accent"><i class="fas fa-dollar-sign"></i></div>
                <div class="stat-value" id="totalRaised">$0</div>
                <div class="stat-label">Total Raised</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon primary"><i class="fas fa-bullhorn"></i></div>
                <div class="stat-value" id="totalCampaigns">0</div>
                <div class="stat-label">Campaigns</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon info"><i class="fas fa-camera"></i></div>
                <div class="stat-value" id="totalSnapshots">0</div>
                <div class="stat-label">Snapshots</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon success"><i class="fas fa-heart"></i></div>
                <div class="stat-value" id="totalDonations">0</div>
                <div class="stat-label">Donations</div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            
            <!-- Funding Trends Chart -->
            <div class="card animate-fadeInUp" style="animation-delay: 0.3s;">
                <div class="card-header">
                    <h5><i class="fas fa-chart-area"></i> Funding Trends</h5>
                    <select class="form-control form-select" style="width: auto; padding: 0.5rem 2.5rem 0.5rem 0.75rem; font-size: 0.8125rem;" id="trendDays" onchange="loadTrends()">
                        <option value="7">7 days</option>
                        <option value="30" selected>30 days</option>
                        <option value="90">90 days</option>
                    </select>
                </div>
                <div class="card-body">
                    <canvas id="trendChart" height="280"></canvas>
                </div>
            </div>

            <!-- Top Campaigns -->
            <div class="card animate-fadeInUp" style="animation-delay: 0.4s;">
                <div class="card-header">
                    <h5><i class="fas fa-trophy"></i> Top Campaigns</h5>
                </div>
                <div class="card-body p-0" id="topCampaigns" style="max-height: 360px; overflow-y: auto;">
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Row -->
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            
            <!-- Activity Chart -->
            <div class="card animate-fadeInUp" style="animation-delay: 0.5s;">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Daily Activity</h5>
                </div>
                <div class="card-body">
                    <canvas id="activityChart" height="200"></canvas>
                </div>
            </div>

            <!-- Categories -->
            <div class="card animate-fadeInUp" style="animation-delay: 0.6s;">
                <div class="card-header">
                    <h5><i class="fas fa-tags"></i> Categories</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Campaigns List -->
        <div class="card animate-fadeInUp" style="animation-delay: 0.7s;">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Tracked Campaigns</h5>
                <span class="badge badge-accent" id="campaignCount">0 campaigns</span>
            </div>
            <div class="card-body p-0" id="campaignList">
                <div class="text-center py-6 text-muted">
                    <i class="fas fa-spinner fa-spin"></i> Loading campaigns...
                </div>
            </div>
            <div id="pagination" class="flex items-center justify-center gap-2 p-4" style="border-top: 1px solid var(--border-color);"></div>
        </div>
    </main>

    <script>
        let trendChart, activityChart, categoryChart;
        let currentPage = 1;

        // Chart.js default config
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#334155';

        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                
                animateValue('totalCampaigns', 0, data.total_campaigns, 500);
                animateValue('totalSnapshots', 0, data.total_snapshots, 500);
                animateValue('totalDonations', 0, data.total_donations, 500);
                document.getElementById('totalRaised').textContent = '$' + (data.total_raised || 0).toLocaleString(undefined, {maximumFractionDigits: 0});
            } catch (e) { console.error(e); }
        }

        function animateValue(id, start, end, duration) {
            const el = document.getElementById(id);
            const range = end - start;
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const value = Math.floor(start + range * progress);
                el.textContent = value.toLocaleString();
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        async function loadTrends() {
            try {
                const days = document.getElementById('trendDays').value;
                const res = await fetch('/api/trends/funding?days=' + days);
                const data = await res.json();
                
                const ctx = document.getElementById('trendChart').getContext('2d');
                
                if (trendChart) trendChart.destroy();
                
                const gradient = ctx.createLinearGradient(0, 0, 0, 280);
                gradient.addColorStop(0, 'rgba(245, 158, 11, 0.3)');
                gradient.addColorStop(1, 'rgba(245, 158, 11, 0)');
                
                trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.trends.map(t => t.date),
                        datasets: [{
                            label: 'Amount Raised',
                            data: data.trends.map(t => t.total_raised),
                            borderColor: '#f59e0b',
                            backgroundColor: gradient,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#f59e0b',
                            pointBorderColor: '#0f172a',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false } },
                            y: { 
                                grid: { color: '#1e293b' },
                                ticks: { callback: v => '$' + v.toLocaleString() }
                            }
                        }
                    }
                });
            } catch (e) { console.error(e); }
        }

        async function loadTopCampaigns() {
            try {
                const res = await fetch('/api/trends/top-campaigns?limit=5');
                const data = await res.json();
                const container = document.getElementById('topCampaigns');
                
                if (!data.campaigns?.length) {
                    container.innerHTML = '<div class="text-center py-6 text-muted">No campaigns yet</div>';
                    return;
                }
                
                const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰', '4', '5'];
                
                container.innerHTML = data.campaigns.map((c, i) => `
                    <div class="list-item flex items-center gap-3" style="cursor: pointer;" onclick="window.open('${c.url}', '_blank')">
                        <span style="font-size: 1.25rem; width: 30px; text-align: center;">${medals[i]}</span>
                        <div style="flex: 1; min-width: 0;">
                            <div class="font-semibold text-sm truncate">${c.title}</div>
                            <div class="flex items-center gap-2">
                                <span class="text-accent font-bold">$${(c.raised || 0).toLocaleString()}</span>
                                <span class="text-xs text-muted">/ $${(c.goal || 0).toLocaleString()}</span>
                            </div>
                            <div class="progress mt-2" style="height: 4px;">
                                <div class="progress-bar" style="width: ${Math.min(c.progress, 100)}%"></div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function loadActivityChart() {
            try {
                const res = await fetch('/api/trends/growth');
                const data = await res.json();
                
                if (activityChart) activityChart.destroy();
                
                activityChart = new Chart(document.getElementById('activityChart'), {
                    type: 'bar',
                    data: {
                        labels: data.data.map(d => d.date),
                        datasets: [{
                            label: 'Campaigns',
                            data: data.data.map(d => d.campaigns),
                            backgroundColor: '#1e3a5f',
                            borderRadius: 4,
                            barThickness: 20
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false } },
                            y: { grid: { color: '#1e293b' }, beginAtZero: true }
                        }
                    }
                });
            } catch (e) { console.error(e); }
        }

        async function loadCategoryChart() {
            try {
                const res = await fetch('/api/trends/categories');
                const data = await res.json();
                
                if (categoryChart) categoryChart.destroy();
                
                const colors = ['#f59e0b', '#1e3a5f', '#10b981', '#06b6d4', '#8b5cf6', '#ec4899'];
                
                categoryChart = new Chart(document.getElementById('categoryChart'), {
                    type: 'doughnut',
                    data: {
                        labels: data.categories.map(c => c.name),
                        datasets: [{
                            data: data.categories.map(c => c.count),
                            backgroundColor: colors,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'right' } },
                        cutout: '65%'
                    }
                });
            } catch (e) { console.error(e); }
        }

        async function loadCampaigns(page = 1) {
            try {
                const res = await fetch('/api/campaigns?page=' + page + '&per_page=10');
                const data = await res.json();
                const list = document.getElementById('campaignList');
                
                document.getElementById('campaignCount').textContent = data.total + ' campaigns';
                
                if (!data.campaigns?.length) {
                    list.innerHTML = '<div class="text-center py-6 text-muted">No campaigns tracked yet. <a href="/" class="text-accent">Start scraping!</a></div>';
                    return;
                }
                
                list.innerHTML = data.campaigns.map(c => {
                    const s = c.latest_snapshot || {};
                    const progress = c.goal_amount ? Math.min((s.amount_raised || 0) / c.goal_amount * 100, 100) : 0;
                    
                    return `
                        <div class="list-item">
                            <div class="flex justify-between items-start gap-4">
                                <div style="flex: 1; min-width: 0;">
                                    <h6 class="font-semibold mb-1 truncate">${c.title || 'Untitled'}</h6>
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="text-accent font-bold">$${(s.amount_raised || 0).toLocaleString()}</span>
                                        <span class="text-sm text-muted">of $${(c.goal_amount || 0).toLocaleString()}</span>
                                    </div>
                                    <div class="progress" style="max-width: 300px;">
                                        <div class="progress-bar" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-ghost btn-sm" onclick="trackCampaign(${c.id}, this)" title="Refresh">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <a href="${c.url}" target="_blank" class="btn btn-ghost btn-sm" title="View">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Pagination
                const pagination = document.getElementById('pagination');
                if (data.pages > 1) {
                    let html = '';
                    for (let i = 1; i <= data.pages; i++) {
                        html += `<button class="btn ${i === page ? 'btn-primary' : 'btn-ghost'} btn-sm" onclick="loadCampaigns(${i})">${i}</button>`;
                    }
                    pagination.innerHTML = html;
                } else {
                    pagination.innerHTML = '';
                }
            } catch (e) { console.error(e); }
        }

        async function trackCampaign(id, btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
            
            try {
                await fetch('/api/campaigns/' + id + '/track', { method: 'POST' });
                loadStats();
                loadCampaigns(currentPage);
                loadTrends();
                loadTopCampaigns();
            } catch (e) { console.error(e); }
            
            btn.innerHTML = '<i class="fas fa-sync-alt"></i>';
            btn.disabled = false;
        }

        async function refreshAll() {
            const btn = document.getElementById('refreshBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            btn.disabled = true;
            
            try {
                const res = await fetch('/api/campaigns?per_page=100');
                const data = await res.json();
                
                for (const c of data.campaigns) {
                    await fetch('/api/campaigns/' + c.id + '/track', { method: 'POST' });
                }
                
                loadStats();
                loadCampaigns(1);
                loadTrends();
                loadTopCampaigns();
            } catch (e) { console.error(e); }
            
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            btn.disabled = false;
        }

        // Initialize
        loadStats();
        loadTrends();
        loadTopCampaigns();
        loadActivityChart();
        loadCategoryChart();
        loadCampaigns();
    </script>
</body>
</html>
