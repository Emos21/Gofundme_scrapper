<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduler - GoFundMe Scraper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #02a95c; }
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .task-card { padding: 20px; border-bottom: 1px solid #eee; }
        .task-card:last-child { border-bottom: none; }
        .badge-active { background: #02a95c; }
        .badge-inactive { background: #6c757d; }
        .btn-primary { background: var(--primary); border: none; }
        .btn-primary:hover { background: #028a4a; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-hand-holding-heart"></i> GoFundMe Scraper</a>
            <div>
                <a href="/" class="btn btn-outline-light btn-sm me-2"><i class="fas fa-search"></i> Scraper</a>
                <a href="/dashboard" class="btn btn-outline-light btn-sm me-2"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a href="/scheduler" class="btn btn-light btn-sm"><i class="fas fa-clock"></i> Scheduler</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-tasks text-primary"></i> Scheduled Tasks</h5>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#taskModal">
                            <i class="fas fa-plus"></i> New Task
                        </button>
                    </div>
                    <div class="card-body p-0" id="taskList">
                        <div class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle text-info"></i> Quick Guide</h5>
                    </div>
                    <div class="card-body">
                        <h6>Task Types:</h6>
                        <ul class="small">
                            <li><strong>Track All</strong> - Re-scrape all tracked campaigns</li>
                            <li><strong>Scrape URLs</strong> - Scrape specific URLs</li>
                            <li><strong>Discover & Scrape</strong> - Find new campaigns and scrape them</li>
                        </ul>
                        <h6>Schedule Options:</h6>
                        <ul class="small">
                            <li><code>hourly</code> - Every hour</li>
                            <li><code>daily</code> - Every day at midnight</li>
                            <li><code>weekly</code> - Every Monday</li>
                            <li><code>every_30_minutes</code> - Every 30 min</li>
                            <li><code>every_6_hours</code> - Every 6 hours</li>
                            <li><code>0 9 * * *</code> - Cron (9 AM daily)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-clock"></i> Create Scheduled Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Task Name</label>
                        <input type="text" class="form-control" id="taskName" placeholder="Daily Campaign Update">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Task Type</label>
                        <select class="form-select" id="taskType">
                            <option value="track_all">Track All Campaigns</option>
                            <option value="discover_and_scrape">Discover & Scrape New</option>
                            <option value="scrape">Scrape Specific URLs</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Schedule</label>
                        <select class="form-select" id="taskSchedule">
                            <option value="hourly">Hourly</option>
                            <option value="every_6_hours">Every 6 Hours</option>
                            <option value="daily" selected>Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="every_30_minutes">Every 30 Minutes</option>
                        </select>
                    </div>
                    <div class="mb-3" id="urlsGroup" style="display: none;">
                        <label class="form-label">URLs (one per line)</label>
                        <textarea class="form-control" id="taskUrls" rows="4"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createTask()">Create Task</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Show/hide URLs input based on task type
        document.getElementById('taskType').addEventListener('change', function() {
            document.getElementById('urlsGroup').style.display = this.value === 'scrape' ? 'block' : 'none';
        });

        async function loadTasks() {
            try {
                const res = await fetch('/api/tasks');
                const data = await res.json();
                const list = document.getElementById('taskList');
                
                if (data.tasks.length === 0) {
                    list.innerHTML = '<div class="text-center text-muted py-4">No scheduled tasks yet</div>';
                    return;
                }
                
                list.innerHTML = data.tasks.map(t => `
                    <div class="task-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${t.name}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-cog"></i> ${t.task_type} | 
                                    <i class="fas fa-clock"></i> ${t.schedule}
                                </small>
                                ${t.next_run ? '<br><small class="text-success"><i class="fas fa-forward"></i> Next: ' + new Date(t.next_run).toLocaleString() + '</small>' : ''}
                                ${t.last_run ? '<br><small class="text-muted"><i class="fas fa-history"></i> Last: ' + new Date(t.last_run).toLocaleString() + '</small>' : ''}
                            </div>
                            <div class="btn-group">
                                <span class="badge ${t.is_active ? 'badge-active' : 'badge-inactive'} me-2">${t.is_active ? 'Active' : 'Paused'}</span>
                                <button class="btn btn-outline-primary btn-sm" onclick="runTask(${t.id})" title="Run Now">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-outline-${t.is_active ? 'warning' : 'success'} btn-sm" onclick="toggleTask(${t.id}, ${!t.is_active})" title="${t.is_active ? 'Pause' : 'Resume'}">
                                    <i class="fas fa-${t.is_active ? 'pause' : 'play'}"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteTask(${t.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading tasks:', e);
            }
        }

        async function createTask() {
            const name = document.getElementById('taskName').value;
            const taskType = document.getElementById('taskType').value;
            const schedule = document.getElementById('taskSchedule').value;
            const urls = document.getElementById('taskUrls').value.split('\n').filter(u => u.trim());

            try {
                await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, task_type: taskType, schedule, urls })
                });
                bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
                loadTasks();
            } catch (e) {
                alert('Error creating task: ' + e.message);
            }
        }

        async function runTask(id) {
            try {
                await fetch(`/api/tasks/${id}/run`, { method: 'POST' });
                alert('Task executed!');
                loadTasks();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function toggleTask(id, isActive) {
            try {
                await fetch(`/api/tasks/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: isActive })
                });
                loadTasks();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function deleteTask(id) {
            if (!confirm('Delete this task?')) return;
            try {
                await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
                loadTasks();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        loadTasks();
    </script>
</body>
</html>
